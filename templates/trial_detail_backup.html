{% extends "base.html" %}

{% block title %}{{ trial.title }} - Quorum{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Trial Header -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-body p-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-4 gap-3">
                    <div class="w-100">
                        <h1 class="mb-3">{{ trial.title }}</h1>
                        <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
                            <span class="trial-status {{ trial.status.lower() }} px-3 py-2">
                                <i data-lucide="{% if trial.status == 'draft' %}edit-3{% elif trial.status == 'open' %}play{% elif trial.status == 'live' %}zap{% else %}check-circle{% endif %}" class="me-2"></i>
                                {{ trial.status.title() }}
                            </span>
                            <span class="badge bg-secondary px-3 py-2">
                                <i data-lucide="target" class="me-1"></i>{{ trial.domain.title() }}
                            </span>
                        </div>
                    </div>
                    {% if user %}
                        {% if user.is_admin %}
                            <!-- Website Admin Controls -->
                            <div class="admin-controls">
                                {% if trial.status == 'draft' %}
                                <button class="btn btn-secondary me-2" onclick="startTrial({{ trial.id }})">
                                    <i data-lucide="play" class="me-1"></i>Start Trial
                                </button>
                                {% endif %}
                                <a href="/trials/{{ trial.id }}/edit" class="btn btn-outline-secondary me-2">
                                    <i data-lucide="edit" class="me-1"></i>Edit Trial
                                </button>
                                {% if trial.status != 'draft' %}
                                <button class="btn btn-outline-danger" onclick="confirmDeleteTrial()">
                                    <i data-lucide="trash-2" class="me-1"></i>Delete Trial
                                </button>
                                {% endif %}
                            </div>
                        {% elif trial.created_by == user.id %}
                            <!-- Trial Creator Controls -->
                            <div class="admin-controls">
                                {% if trial.status == 'draft' %}
                                <button class="btn btn-secondary me-2" onclick="startTrial({{ trial.id }})">
                                    <i data-lucide="play" class="me-1"></i>Start Trial
                                </button>
                                <a href="/trials/{{ trial.id }}/edit" class="btn btn-outline-secondary">
                                    <i data-lucide="edit" class="me-1"></i>Edit Trial
                                </button>
                                {% else %}
                                <span class="badge bg-info">Trial Creator</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% set event_spec = trial.event_spec_json | from_json %}
                {% if event_spec and event_spec.get('description') %}
                <div class="mt-4">
                    <div class="d-flex align-items-center mb-2">
                        <i data-lucide="info" class="text-secondary me-2"></i>
                        <h5 class="mb-0">Trial Description</h5>
                    </div>
                    <p class="text-muted">{{ event_spec.get('description') }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Outcomes Section -->
        <div class="mb-4">
            <h2 class="mb-4">
                <i data-lucide="target" class="me-2 text-secondary"></i>
                Outcomes
                {% if trial.status == 'settled' and result and winning_outcome_id %}
                    <span class="badge bg-secondary ms-2">Settled</span>
                {% endif %}
            </h2>
            
            <div class="row">
                {% for outcome in outcomes %}
                    {% if not (trial.status == 'settled' and result and winning_outcome_id and outcome.id != winning_outcome_id) %}
                        <!-- Show this outcome (all for active trials, only winner for settled) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}border-secondary{% endif %}">
                                <div class="card-header text-center {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}bg-light border-bottom{% else %}bg-light border-bottom{% endif %}">
                                    <h5 class="mb-0">
                                        {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}
                                        <i data-lucide="award" class="me-2 text-warning"></i>
                                        {% endif %}
                                        {{ outcome.label }}
                                        {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}
                                        <span class="badge bg-secondary text-light ms-2">WINNER</span>
                                        {% endif %}
                                    </h5>
                                </div>
                                <div class="card-body">
                            {% if targets_by_outcome.get(outcome.id) %}
                                <div class="targets-grid">
                                    {% for target in targets_by_outcome[outcome.id] %}
                                    <div class="target-container">
                                        <!-- Image Display -->
                                        {% if user %}
                                            {% if user.is_admin or (trial.created_by == user.id) %}
                                                {% if trial.status in ['draft', 'open', 'live'] %}
                                                <!-- Admin/Trial Creator with Warning -->
                                                <div class="protected-image admin-protected" 
                                                     data-user-type="{% if user.is_admin %}admin{% else %}trial_creator{% endif %}"
                                                     onclick="revealTargetImageAdmin(this)">
                                                    <div class="protection-overlay">
                                                        <button class="reveal-image-btn admin-reveal-btn">
                                                            <i data-lucide="eye" class="me-1"></i>Reveal Image
                                                        </button>
                                                    </div>
                                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="d-none target-image-hidden" />
                                                </div>
                                                {% else %}
                                                <!-- Settled Trial - Show Image -->
                                                <div class="target-image-wrapper">
                                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="target-image" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div class="image-fallback d-none">
                                                        <i data-lucide="image" class="fallback-icon"></i>
                                                        <span>{{ target.description or 'Image unavailable' }}</span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% else %}
                                                <!-- Regular User - Always Protected -->
                                                <div class="protected-image user-protected">
                                                    <div class="protection-overlay">
                                                        <div class="user-restriction">
                                                            <i data-lucide="lock" class="restriction-icon"></i>
                                                            <span class="restriction-text">Image Protected</span>
                                                            <small class="restriction-hint">Only available after trial completion</small>
                                                        </div>
                                                    </div>
                                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="d-none target-image-hidden" />
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Not Logged In -->
                                            <div class="protected-image user-protected">
                                                <div class="protection-overlay">
                                                    <div class="user-restriction">
                                                        <i data-lucide="lock" class="restriction-icon"></i>
                                                        <span class="restriction-text">Login Required</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if trial.domain == 'lottery' %}
                                            {% if user %}
                                                <div class="mt-3 alert alert-success">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i data-lucide="eye" class="me-2"></i>
                                                            <strong>ARV Viewer Mode:</strong> Use the enhanced viewer wizard for systematic ball-by-ball impression recording
                                                        </div>
                                                        <a href="/trials/{{ trial.id }}/arv-wizard" class="btn btn-sm btn-success">
                                                            <i data-lucide="target" class="me-2"></i>Start ARV Session
                                                        </a>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="mt-3 alert alert-info">
                                                    <i data-lucide="info" class="me-2"></i>
                                                    <strong>Enhanced Lottery Features:</strong> Login to access ball-specific descriptors and collaborative sensory impression tools.
                                                    <a href="/login" class="alert-link ms-2">Login here</a>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if trial.domain == 'lottery' %}
                                        <!-- Existing Ball Descriptors -->
                                        {% set ball_descriptors = target_descriptors.get(outcome.id|string + '_' + target.id|string, []) %}
                                        {% if ball_descriptors %}
                                        <div class="mt-3 p-2 border rounded bg-white">
                                            <h6 class="mb-2 text-muted">
                                                <i data-lucide="message-circle" class="me-1"></i>
                                                Current Descriptors for {{ outcome.label }}
                                            </h6>
                                            <div class="small">
                                                {% for desc in ball_descriptors %}
                                                <div class="mb-2 p-2 border-start border-3 border-primary bg-light">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <span class="badge bg-{{ 'primary' if desc.category == 'colours' else 'secondary' if desc.category == 'tactile' else 'success' if desc.category == 'energy' else 'warning' if desc.category == 'smell' else 'info' if desc.category == 'sound' else 'dark' }} me-1">
                                                                {{ desc.category.title() }}
                                                            </span>
                                                            <small class="text-muted">by {{ desc.author or 'Anonymous' }}</small>
                                                        </div>
                                                        <small class="text-muted">{{ desc.created_at.strftime('%m/%d %H:%M') }}</small>
                                                    </div>
                                                    <div class="mt-1">{{ desc.text }}</div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if user and trial.status in ['open', 'live'] %}
                                        <!-- Lottery Ball Descriptor Section -->
                                        <div class="mt-3 p-3 bg-light rounded">
                                            <h6 class="mb-2">
                                                <i data-lucide="edit-3" class="me-1"></i>
                                                Add Descriptors for {{ outcome.label }}
                                            </h6>
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <select class="form-select form-select-sm" id="category_{{ outcome.id }}_{{ target.id }}">
                                                        <option value="colours">Colours</option>
                                                        <option value="tactile">Tactile</option>
                                                        <option value="energy">Energy</option>
                                                        <option value="smell">Smell</option>
                                                        <option value="sound">Sound</option>
                                                        <option value="visual">Visual</option>
                                                    </select>
                                                </div>
                                                <div class="col-12">
                                                    <textarea class="form-control form-control-sm" 
                                                              id="descriptor_{{ outcome.id }}_{{ target.id }}" 
                                                              rows="2" 
                                                              placeholder="Describe your impressions for this specific ball..."></textarea>
                                                </div>
                                                <div class="col-12">
                                                    <button class="btn btn-primary btn-sm" 
                                                            onclick="addBallDescriptor({{ trial.id }}, {{ outcome.id }}, {{ target.id }})">
                                                        <i data-lucide="plus" class="me-1"></i>Add Descriptor
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
                                    <div class="no-target">
                                        <i data-lucide="image" class="text-muted mb-3" style="width: 48px; height: 48px;"></i>
                                        <p class="text-muted mb-0 fs-5 fw-semibold">No target assigned</p>
                                        <small class="text-muted mt-2">Waiting for admin assignment</small>
                                    </div>
                                </div>
                            {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Message for hidden losing outcomes in settled trials -->
        {% if trial.status == 'settled' and result and winning_outcome_id %}
        <div class="alert alert-info mt-3">
            <i data-lucide="eye-off" class="me-2"></i>
            <strong>RV Displacement Prevention:</strong> Only the winning target is shown after settlement to maintain the integrity of future remote viewing sessions.
        </div>
        {% endif %}

        <!-- Remote Viewing Session -->
        {% if user and trial.status in ['open', 'live'] %}
        <div class="card mb-4" id="rv-session-card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i data-lucide="eye" class="me-2"></i>Remote Viewing Session</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i data-lucide="alert-triangle" class="me-2"></i>
                    <strong>Important:</strong> Submit your impressions based on your remote viewing session. Focus on sensory details and impressions rather than analytical thoughts.
                </div>
                
                <!-- Descriptor Categories -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="descriptor-category">
                            <h6><i data-lucide="palette" class="me-2"></i>Colours</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Dominant colors, hues, brightness..."></textarea>
                        </div>
                        <div class="descriptor-category">
                            <h6><i data-lucide="hand" class="me-2"></i>Tactile</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Textures, temperatures, physical sensations..."></textarea>
                        </div>
                        <div class="descriptor-category">
                            <h6><i data-lucide="zap" class="me-2"></i>Energy</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Movement, stillness, intensity, pace..."></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="descriptor-category">
                            <h6><i data-lucide="wind" class="me-2"></i>Smell</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Odors, scents, freshness..."></textarea>
                        </div>
                        <div class="descriptor-category">
                            <h6><i data-lucide="volume-2" class="me-2"></i>Sound</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Acoustic qualities, noises..."></textarea>
                        </div>
                        <div class="descriptor-category">
                            <h6><i data-lucide="eye" class="me-2"></i>Visual</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Shapes, patterns, structures..."></textarea>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="checkParticipationEligibility()">
                    <i data-lucide="save" class="me-2"></i>Submit Descriptors
                </button>
            </div>
        </div>
        {% endif %}

        <!-- AI Judge Trial -->
        {% if user and user.is_admin and trial.status in ['open', 'live'] %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i data-lucide="cpu" class="me-2"></i>AI Judge Trial</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i data-lucide="info" class="me-2"></i>
                    <strong>Automated AI Judging:</strong> The AI will analyze all submitted descriptors against each target image to determine accuracy percentages and automatically select the winner.
                </div>
                
                <div class="mb-3">
                    <h6>Current Descriptors:</h6>
                    {% if descriptors %}
                    <div class="descriptor-summary">
                        {% for desc in descriptors[:3] %}
                        <div class="badge bg-secondary me-1 mb-1">{{ desc.category or 'general' }}: {{ desc.text[:30] }}{% if desc.text|length > 30 %}...{% endif %}</div>
                        {% endfor %}
                        {% if descriptors|length > 3 %}
                        <div class="text-muted small">+ {{ descriptors|length - 3 }} more descriptors</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-muted">No descriptors submitted yet</div>
                    {% endif %}
                </div>
                
                <form method="POST" action="/trials/{{ trial.id }}/ai_judge" onsubmit="showJudgingProgress()">
                    <button type="submit" class="btn btn-primary" {% if not descriptors %}disabled title="No descriptors available for judging"{% endif %}>
                        <i data-lucide="zap" class="me-2"></i>Start AI Judging
                    </button>
                </form>
                
                <div id="judging-progress" class="d-none mt-3">
                    <div class="alert alert-primary">
                        <i data-lucide="loader" class="me-2 spinner"></i>
                        AI is analyzing descriptors against targets... This may take a few moments.
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Back to Trials -->
        <div class="mb-4">
            <a href="/trials" class="btn btn-outline-secondary">
                <i data-lucide="arrow-left" class="me-2"></i>Back to Trials
            </a>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Trial Info Sidebar -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i data-lucide="info" class="me-2"></i>
                    Trial Information
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Status:</strong>
                    <span class="trial-status {{ trial.status.lower() }} px-2 py-1 small ms-2">
                        {{ trial.status.title() }}
                    </span>
                </div>
                <div class="mb-3">
                    <strong>Domain:</strong>
                    <span class="badge bg-primary ms-2">{{ trial.domain.title() }}</span>
                </div>
                <div class="mb-3">
                    <strong>Result Time:</strong>
                    <p class="mb-0 small text-muted">{{ trial.result_time_utc.strftime('%Y-%m-%d %H:%M UTC') }}</p>
                </div>
                <div class="mb-3">
                    <strong>Outcomes:</strong>
                    <p class="mb-0 small text-muted">{{ outcomes|length }} possible outcomes</p>
                </div>
                {% if descriptors %}
                <div class="mb-3">
                    <strong>Descriptors:</strong>
                    <p class="mb-0 small text-muted">{{ descriptors|length }} submitted</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        {% if user %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i data-lucide="zap" class="me-2"></i>
                    Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if user.is_admin or trial.created_by == user.id %}
                        {% if trial.status == 'draft' %}
                        <button class="btn btn-success btn-sm" onclick="startTrial({{ trial.id }})">
                            <i data-lucide="play" class="me-2"></i>Start Trial
                        </button>
                        {% endif %}
                        <a href="/trials/{{ trial.id }}/edit" class="btn btn-outline-primary btn-sm">
                            <i data-lucide="edit" class="me-2"></i>Edit Trial
                        </a>
                    {% endif %}
                    <a href="/trials" class="btn btn-outline-secondary btn-sm">
                        <i data-lucide="list" class="me-2"></i>All Trials
                    </a>
                    {% if user.is_admin %}
                    <a href="/admin" class="btn btn-outline-info btn-sm">
                        <i data-lucide="settings" class="me-2"></i>Admin Panel
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Platform Info -->
        <div class="alert alert-info">
            <i data-lucide="info"></i>
            <strong>ARV Protocol:</strong> This platform follows strict Associative Remote Viewing protocols to maintain scientific integrity.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Track if user has viewed content
let hasViewedContent = false;

// Admin/Trial Creator reveal image with warning
function revealTargetImageAdmin(element) {
    const userType = element.dataset.userType;
    const userTypeText = userType === 'admin' ? 'Website Administrator' : 'Trial Creator';
    
    const message = `WARNING: ${userTypeText}\n\n` +
                  `Viewing this image will prevent you from participating in this trial's remote viewing session. ` +
                  `This restriction maintains the scientific integrity of the ARV process.\n\n` +
                  `Do you want to continue and view the image?`;
    
    if (confirm(message)) {
        const overlay = element.querySelector('.protection-overlay');
        const hiddenImage = element.querySelector('.target-image-hidden');
        
        if (overlay && hiddenImage) {
            overlay.style.display = 'none';
            hiddenImage.classList.remove('d-none');
            hiddenImage.classList.add('target-image');
            hiddenImage.style.display = 'block';
            
            // Mark as viewed and update participation status
            hasViewedContent = true;
            updateParticipationStatus();
        }
    }
}

function updateParticipationStatus() {
    if (hasViewedContent) {
        const rvCard = document.getElementById('rv-session-card');
        if (rvCard) {
            rvCard.innerHTML = `
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i data-lucide="alert-triangle" class="me-2"></i>Participation Restricted</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i data-lucide="shield-off" class="me-2"></i>
                        <strong>Unable to Participate:</strong> You have viewed protected content (images or tags) which prevents 
                        participation in this trial's remote viewing session to maintain scientific integrity.
                    </div>
                </div>
            `;
        }
    }
}

function checkParticipationEligibility() {
    if (hasViewedContent) {
        alert('Unable to submit descriptors: You have viewed protected content which prevents participation in this trial.');
        return false;
    }
    // Submit descriptors logic here
    alert('Descriptors submitted successfully!');
    return true;
}

function showJudgingProgress() {
    document.getElementById('judging-progress').classList.remove('d-none');
}

function confirmDeleteTrial() {
    if (confirm('Are you sure you want to delete this trial? This action cannot be undone.')) {
        // Delete trial logic here
        window.location.href = '/trials/{{ trial.id }}/delete';
    }
}

async function startTrial(trialId) {
    try {
        const response = await fetch(`/trials/${trialId}/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to start trial');
        }
    } catch (error) {
        console.error('Error starting trial:', error);
        alert('Error starting trial');
    }
}

// Add descriptor for specific lottery ball/target
async function addBallDescriptor(trialId, outcomeId, targetId) {
    const categorySelect = document.getElementById(`category_${outcomeId}_${targetId}`);
    const descriptorTextarea = document.getElementById(`descriptor_${outcomeId}_${targetId}`);
    
    const category = categorySelect.value;
    const text = descriptorTextarea.value.trim();
    
    if (!text) {
        alert('Please enter a descriptor text');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('text', text);
        formData.append('category', category);
        formData.append('outcome_id', outcomeId);
        formData.append('target_id', targetId);
        
        const response = await fetch(`/trials/${trialId}/descriptors`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // Clear the form
            descriptorTextarea.value = '';
            categorySelect.value = 'colours';
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
            successMsg.innerHTML = `
                <i data-lucide="check-circle" class="me-2"></i>
                <strong>Descriptor added!</strong> Your ${category} impression has been submitted.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const buttonContainer = document.querySelector(`#descriptor_${outcomeId}_${targetId}`).parentElement.nextElementSibling;
            buttonContainer.insertAdjacentElement('afterend', successMsg);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.remove();
                }
            }, 3000);
            
            // Refresh feather icons
            window.initializeLucideIcons();
            
        } else {
            throw new Error('Failed to add descriptor');
        }
        
    } catch (error) {
        console.error('Error adding descriptor:', error);
        alert('Error adding descriptor. Please try again.');
    }
}
</script>
{% endblock %}