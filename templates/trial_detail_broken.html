<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ trial.title }} - Quorum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.js"></script>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i data-lucide="eye" class="me-2"></i>Quorum
            </a>
            <div class="navbar-nav ms-auto">
                {% if user %}
                    <span class="navbar-text me-3">{{ user.email }}{% if user.is_admin %} (Admin){% endif %}</span>
                    <a class="nav-link" href="/logout">Logout</a>
                {% else %}
                    <a class="nav-link" href="/login">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Trial Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="h3 mb-0">{{ trial.title }}</h1>
                        <div class="mt-2">
                            <span class="badge 
                                {% if trial.status == 'draft' %}bg-secondary{% endif %}
                                {% if trial.status == 'open' %}bg-primary{% endif %}
                                {% if trial.status == 'live' %}bg-success{% endif %}
                                {% if trial.status == 'settled' %}bg-info{% endif %}
                                me-2">{{ trial.status.title() }}</span>
                            <span class="badge bg-outline-secondary">{{ trial.domain.title() }}</span>
                        </div>
                    </div>
                    {% if user %}
                        {% if user.is_admin %}
                            <!-- Website Admin Controls -->
                            <div class="admin-controls">
                                {% if trial.status == 'draft' %}
                                <a href="/trials/{{ trial.id }}/start" class="btn btn-success me-2">
                                    <i data-lucide="play" class="me-1"></i>Start Trial
                                </a>
                                {% endif %}
                                <a href="/trials/{{ trial.id }}/edit" class="btn btn-outline-primary me-2">
                                    <i data-lucide="edit" class="me-1"></i>Edit Trial
                                </a>
                                {% if trial.status != 'draft' %}
                                <button class="btn btn-outline-danger" onclick="confirmDeleteTrial()">
                                    <i data-lucide="trash-2" class="me-1"></i>Delete Trial
                                </button>
                                {% endif %}
                            </div>
                        {% elif trial.created_by == user.id %}
                            <!-- Trial Creator Controls -->
                            <div class="admin-controls">
                                {% if trial.status == 'draft' %}
                                <a href="/trials/{{ trial.id }}/start" class="btn btn-success me-2">
                                    <i data-lucide="play" class="me-1"></i>Start Trial
                                </a>
                                <a href="/trials/{{ trial.id }}/edit" class="btn btn-outline-primary">
                                    <i data-lucide="edit" class="me-1"></i>Edit Trial
                                </a>
                                {% else %}
                                <span class="badge bg-info">Trial Creator</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% set event_spec = trial.event_spec_json | from_json %}
                {% if event_spec and event_spec.get('description') %}
                <div class="mt-3 pt-3 border-top">
                    <strong>Description:</strong> {{ event_spec.get('description') }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Responsive Outcomes Grid -->
        <div class="trial-outcomes-grid">
            {% for outcome in outcomes %}
                {% if not (trial.status == 'settled' and result and winning_outcome_id and outcome.id != winning_outcome_id) %}
                    <!-- Show this outcome (all for active trials, only winner for settled) -->
                    <div class="outcome-card card h-100">
                        <div class="card-header {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}bg-success text-white{% else %}bg-light{% endif %}">
                            <h6 class="mb-0 text-center">
                                {{ outcome.label }}
                                {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}
                                <i data-lucide="award" class="ms-2"></i>
                                {% endif %}
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if targets_by_outcome.get(outcome.id) %}
                    <div class="targets-grid">
                        {% for target in targets_by_outcome[outcome.id] %}
                        <div class="target-container">
                            <!-- Image Display -->
                            {% if user %}
                                {% if user.is_admin or (trial.created_by == user.id) %}
                                    {% if trial.status in ['draft', 'open', 'live'] %}
                                    <!-- Admin/Trial Creator with Warning -->
                                    <div class="protected-image admin-protected" 
                                         data-user-type="{% if user.is_admin %}admin{% else %}trial_creator{% endif %}"
                                         onclick="revealTargetImageAdmin(this)">
                                        <div class="protection-overlay">
                                            <button class="reveal-image-btn admin-reveal-btn">
                                                <i data-lucide="eye" class="me-1"></i>Reveal Image
                                            </button>
                                        </div>
                                        <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="d-none target-image-hidden" />
                                    </div>
                                    {% else %}
                                    <!-- Settled Trial - Show Image -->
                                    <div class="target-image-wrapper">
                                        <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="target-image" 
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                        <div class="image-fallback d-none">
                                            <i data-lucide="image" class="fallback-icon"></i>
                                            <span>{{ target.description or 'Image unavailable' }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <!-- Regular User - Always Protected -->
                                    <div class="protected-image user-protected">
                                        <div class="protection-overlay">
                                            <div class="user-restriction">
                                                <i data-lucide="lock" class="restriction-icon"></i>
                                                <span class="restriction-text">Image Protected</span>
                                                <small class="restriction-hint">Only available after trial completion</small>
                                            </div>
                                        </div>
                                        <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="d-none target-image-hidden" />
                                    </div>
                                {% endif %}
                            {% else %}
                                <!-- Not Logged In -->
                                <div class="protected-image user-protected">
                                    <div class="protection-overlay">
                                        <div class="user-restriction">
                                            <i data-lucide="lock" class="restriction-icon"></i>
                                            <span class="restriction-text">Login Required</span>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Tags Display -->
                            <div class="target-tags">
                                {% if user %}
                                    {% if user.is_admin or (trial.created_by == user.id) %}
                                        {% if trial.status in ['draft', 'open', 'live'] %}
                                        <!-- Admin/Trial Creator Protected Tags -->
                                        <button class="btn btn-reveal-tags admin-reveal-tags" 
                                                data-user-type="{% if user.is_admin %}admin{% else %}trial_creator{% endif %}"
                                                onclick="revealTagsAdmin(this)">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" class="me-1">
                                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                            </svg>
                                            Reveal Tags
                                        </button>
                                        <div class="admin-protected-tags d-none">
                                            {% if target.tags %}
                                                <div class="tag-list mt-2">
                                                    {% for tag in target.tags.split(',') if tag.strip() %}
                                                    <span class="badge bg-secondary me-1">{{ tag.strip() }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        <!-- Settled Trial - Hide Tags to Prevent RV Displacement -->
                                        <div class="settled-tags-hidden">
                                            <span class="badge bg-info">
                                                <i data-lucide="eye-off" width="12" height="12" class="me-1"></i>
                                                Tags Hidden (RV Protection)
                                            </span>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <!-- Regular User - No Tags Access -->
                                        <div class="user-restricted-tags">
                                            <span class="badge bg-secondary opacity-50">
                                                <i data-lucide="lock" width="12" height="12" class="me-1"></i>Tags Protected
                                            </span>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <!-- Not Logged In -->
                                    <div class="user-restricted-tags">
                                        <span class="badge bg-secondary opacity-50">
                                            <i data-lucide="lock" width="12" height="12" class="me-1"></i>Login Required
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="d-flex justify-content-center">
                        <div class="no-target">
                            {% if trial.status == 'settled' and result and winning_outcome_id and outcome.id != winning_outcome_id %}
                            <i data-lucide="eye-off" class="text-muted mb-2"></i>
                            <p class="text-muted mb-0">Hidden to prevent RV displacement</p>
                            <small class="text-muted">Only winning outcome shown after settlement</small>
                            {% else %}
                            <i data-lucide="image" class="text-muted mb-2"></i>
                            <p class="text-muted mb-0">No target assigned</p>
                            {% endif %}
                                <div class="targets-grid">
                                    {% for target in targets_by_outcome[outcome.id] %}
                                    <div class="target-container">
                                        <!-- Image Display -->
                                        {% if user %}
                                            {% if user.is_admin or (trial.created_by == user.id) %}
                                                {% if trial.status in ['draft', 'open', 'live'] %}
                                                <!-- Admin/Trial Creator with Warning -->
                                                <div class="protected-image admin-protected" 
                                                     data-user-type="{% if user.is_admin %}admin{% else %}trial_creator{% endif %}"
                                                     onclick="revealTargetImageAdmin(this)">
                                                    <div class="protection-overlay">
                                                        <button class="reveal-image-btn admin-reveal-btn">
                                                            <i data-lucide="eye" class="me-1"></i>Reveal Image
                                                        </button>
                                                    </div>
                                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="d-none target-image-hidden" />
                                                </div>
                                                {% else %}
                                                <!-- Settled Trial - Show Image -->
                                                <div class="target-image-wrapper">
                                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="target-image" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div class="image-fallback d-none">
                                                        <i data-lucide="image" class="fallback-icon"></i>
                                                        <span>{{ target.description or 'Image unavailable' }}</span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% else %}
                                                <!-- Regular User - Always Protected -->
                                                <div class="protected-image user-protected">
                                                    <div class="protection-overlay">
                                                        <div class="user-restriction">
                                                            <i data-lucide="lock" class="restriction-icon"></i>
                                                            <span class="restriction-text">Image Protected</span>
                                                            <small class="restriction-hint">Only available after trial completion</small>
                                                        </div>
                                                    </div>
                                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" alt="{{ target.description }}" class="d-none target-image-hidden" />
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Not Logged In -->
                                            <div class="protected-image user-protected">
                                                <div class="protection-overlay">
                                                    <div class="user-restriction">
                                                        <i data-lucide="lock" class="restriction-icon"></i>
                                                        <span class="restriction-text">Login Required</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Tags Display -->
                                        <div class="target-tags">
                                            {% if user %}
                                                {% if user.is_admin or (trial.created_by == user.id) %}
                                                    {% if trial.status in ['draft', 'open', 'live'] %}
                                                    <!-- Admin/Trial Creator Protected Tags -->
                                                    <button class="btn btn-reveal-tags admin-reveal-tags" 
                                                            data-user-type="{% if user.is_admin %}admin{% else %}trial_creator{% endif %}"
                                                            onclick="revealTagsAdmin(this)">
                                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" class="me-1">
                                                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                                            <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                                        </svg>
                                                        Reveal Tags
                                                    </button>
                                                    <div class="admin-protected-tags d-none">
                                                        {% if target.tags %}
                                                            <div class="tag-list mt-2">
                                                                {% for tag in target.tags.split(',') if tag.strip() %}
                                                                <span class="badge bg-secondary me-1">{{ tag.strip() }}</span>
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <!-- Settled Trial - Hide Tags to Prevent RV Displacement -->
                                                    <div class="settled-tags-hidden">
                                                        <span class="badge bg-info">
                                                            <i data-lucide="eye-off" width="12" height="12" class="me-1"></i>
                                                            Tags Hidden (RV Protection)
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                {% else %}
                                                    <!-- Regular User - No Tags Access -->
                                                    <div class="user-restricted-tags">
                                                        <span class="badge bg-secondary opacity-50">
                                                            <i data-lucide="lock" width="12" height="12" class="me-1"></i>Tags Protected
                                                        </span>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <!-- Not Logged In -->
                                                <div class="user-restricted-tags">
                                                    <span class="badge bg-secondary opacity-50">
                                                        <i data-lucide="lock" width="12" height="12" class="me-1"></i>Login Required
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="d-flex justify-content-center">
                                    <div class="no-target">
                                        <i data-lucide="image" class="text-muted mb-2"></i>
                                        <p class="text-muted mb-0">No target assigned</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Message for hidden losing outcomes in settled trials -->
        {% if trial.status == 'settled' and result and winning_outcome_id %}
        <div class="alert alert-info mt-3">
            <i data-lucide="eye-off" class="me-2"></i>
            <strong>RV Displacement Prevention:</strong> Only the winning target is shown after settlement to maintain the integrity of future remote viewing sessions.
        </div>
        {% endif %}

        <!-- Remote Viewing Session -->
        {% if user and trial.status in ['open', 'live'] %}
        <div class="card mb-4" id="rv-session-card">
            <div class="card-header">
                <h5 class="mb-0"><i data-lucide="edit-3" class="me-2"></i>Remote Viewing Session</h5>
            </div>
            <div class="card-body">
                <!-- Participation Check -->
                <div id="participation-check" class="d-none">
                    <div class="alert alert-warning">
                        <i data-lucide="alert-triangle" class="me-2"></i>
                        <strong>Participation Restricted:</strong> You have viewed target content for this trial, 
                        which may compromise the integrity of your remote viewing session. 
                        To maintain scientific validity, you cannot submit observations for this trial.
                    </div>
                </div>
                
                <div id="rv-form">
                    <!-- ARV Guidance -->
                    <div class="alert alert-info mb-4">
                        <i data-lucide="info" class="me-2"></i>
                        <strong>Remote Viewing Protocol:</strong> Focus on immediate perceptions without analysis. 
                        Describe what you sense across different sensory channels.
                    </div>
                    
                    <!-- Descriptor Categories -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i data-lucide="eye" class="me-2"></i>Visual Descriptors</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Shapes, patterns, movement, lighting..."></textarea>
                            
                            <h6><i data-lucide="droplet" class="me-2"></i>Colors</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Hues, intensities, patterns..."></textarea>
                            
                            <h6><i data-lucide="zap" class="me-2"></i>Energy</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Vibrational quality, intensity..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <h6><i data-lucide="hand" class="me-2"></i>Tactile</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Textures, temperatures, physical sensations..."></textarea>
                            
                            <h6><i data-lucide="wind" class="me-2"></i>Smell</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Scents, odors, aromatic qualities..."></textarea>
                            
                            <h6><i data-lucide="volume-2" class="me-2"></i>Sound</h6>
                            <textarea class="form-control mb-3" rows="3" placeholder="Acoustic qualities, noises..."></textarea>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="checkParticipationEligibility()">
                        <i data-lucide="save" class="me-2"></i>Submit Descriptors
                    </button>
                </div>
            </div>
        </div>
        {% endif %}





        <!-- AI Judge Trial -->
        {% if user and user.is_admin and trial.status in ['open', 'live'] %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i data-lucide="cpu" class="me-2"></i>AI Judge Trial</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i data-lucide="info" class="me-2"></i>
                    <strong>Automated AI Judging:</strong> The AI will analyze all submitted descriptors against each target image to determine accuracy percentages and automatically select the winner.
                </div>
                
                <div class="mb-3">
                    <h6>Current Descriptors:</h6>
                    {% if descriptors %}
                    <div class="descriptor-summary">
                        {% for desc in descriptors[:3] %}
                        <div class="badge bg-secondary me-1 mb-1">{{ desc.category or 'general' }}: {{ desc.text[:30] }}{% if desc.text|length > 30 %}...{% endif %}</div>
                        {% endfor %}
                        {% if descriptors|length > 3 %}
                        <div class="text-muted small">+ {{ descriptors|length - 3 }} more descriptors</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-muted">No descriptors submitted yet</div>
                    {% endif %}
                </div>
                
                <form method="POST" action="/trials/{{ trial.id }}/ai_judge" onsubmit="showJudgingProgress()">
                    <button type="submit" class="btn btn-primary" {% if not descriptors %}disabled title="No descriptors available for judging"{% endif %}>
                        <i data-lucide="zap" class="me-2"></i>Start AI Judging
                    </button>
                </form>
                
                <div id="judging-progress" class="d-none mt-3">
                    <div class="alert alert-primary">
                        <i data-lucide="loader" class="me-2 spinner"></i>
                        AI is analyzing descriptors against targets... This may take a few moments.
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Back to Trials -->
        <div class="mb-4">
            <a href="/trials" class="btn btn-outline-secondary">
                <i data-lucide="arrow-left" class="me-2"></i>Back to Trials
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.initializeLucideIcons();
        
        // Track if user has viewed content
        let hasViewedContent = false;
        
        // Admin/Trial Creator reveal image with warning
        function revealTargetImageAdmin(element) {
            const userType = element.dataset.userType;
            const userTypeText = userType === 'admin' ? 'Website Administrator' : 'Trial Creator';
            
            const message = `WARNING: ${userTypeText}\n\n` +
                          `Viewing this image will prevent you from participating in this trial's remote viewing session. ` +
                          `This restriction maintains the scientific integrity of the ARV process.\n\n` +
                          `Do you want to continue and view the image?`;
            
            if (confirm(message)) {
                const overlay = element.querySelector('.protection-overlay');
                const hiddenImage = element.querySelector('.target-image-hidden');
                
                if (overlay && hiddenImage) {
                    overlay.style.display = 'none';
                    hiddenImage.classList.remove('d-none');
                    hiddenImage.classList.add('target-image');
                    hiddenImage.style.display = 'block';
                    
                    // Mark as viewed and update participation status
                    hasViewedContent = true;
                    updateParticipationStatus();
                }
            }
        }
        
        // Admin/Trial Creator reveal tags with warning
        function revealTagsAdmin(button) {
            const userType = button.dataset.userType;
            const userTypeText = userType === 'admin' ? 'Website Administrator' : 'Trial Creator';
            
            const message = `WARNING: ${userTypeText}\n\n` +
                          `Viewing these tags will prevent you from participating in this trial's remote viewing session. ` +
                          `This restriction maintains the scientific integrity of the ARV process.\n\n` +
                          `Do you want to continue and view the tags?`;
            
            if (confirm(message)) {
                const container = button.closest('.target-tags');
                const protectedTags = container.querySelector('.admin-protected-tags');
                
                if (protectedTags) {
                    button.style.display = 'none';
                    protectedTags.classList.remove('d-none');
                    
                    // Mark as viewed and update participation status
                    hasViewedContent = true;
                    updateParticipationStatus();
                }
            }
        }
        
        // Update participation status
        function updateParticipationStatus() {
            const rvCard = document.getElementById('rv-session-card');
            
            if (hasViewedContent && rvCard) {
                const participationCheck = rvCard.querySelector('#participation-check');
                const rvForm = rvCard.querySelector('#rv-form');
                
                if (participationCheck && rvForm) {
                    participationCheck.classList.remove('d-none');
                    rvForm.classList.add('d-none');
                }
            }
        }
        

        
        // Check participation eligibility for descriptors
        function checkParticipationEligibility() {
            if (hasViewedContent) {
                alert('You cannot submit observations because you have viewed target content for this trial. This maintains the scientific integrity of the remote viewing process.');
                return false;
            }
            // Proceed with submission
            return true;
        }
        

        
        // Reveal target image for admin/trial creator with warning
        function revealTargetImageAdmin(element) {
            const userType = element.dataset.userType;
            const isAdmin = userType === 'admin';
            
            const message = `Warning: Viewing target images may compromise your ability to participate in this trial.\n\n` +
                          `Once you view any target content, you will be blocked from making predictions or submitting observations ` +
                          `to maintain the scientific integrity of the remote viewing process.\n\n` +
                          `Are you sure you want to reveal this image?`;
            
            if (confirm(message)) {
                // Hide the overlay and show the image
                const overlay = element.querySelector('.protection-overlay');
                const image = element.querySelector('.target-image-hidden');
                
                if (overlay && image) {
                    overlay.style.display = 'none';
                    image.classList.remove('d-none');
                    image.classList.add('target-image');
                    
                    // Mark that content has been viewed
                    hasViewedContent = true;
                    updateParticipationStatus();
                }
            }
        }
        

        
        // Confirm trial deletion (admin only)
        function confirmDeleteTrial() {
            const message = 'Are you sure you want to delete this trial? This action cannot be undone and will remove all associated data.';
            if (confirm(message)) {
                // Implement deletion logic here
                window.location.href = `/trials/{{ trial.id }}/delete`;
            }
        }
        
        // Show judging progress
        function showJudgingProgress() {
            const progressDiv = document.getElementById('judging-progress');
            if (progressDiv) {
                progressDiv.classList.remove('d-none');
            }
            return true;
        }
    </script>
    
    <!-- WebSocket Connection -->
    <script src="/static/app.js"></script>
</body>
</html>