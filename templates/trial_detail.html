{% extends "base.html" %}

{% block title %}{{ trial.title }} | Remote Viewing Prediction Task - ARVLab{% endblock %}

{% block breadcrumb_items %},
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Tasks",
                "item": "https://arvlab.xyz/trials"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": {{ trial.domain.title()|tojson }},
                "item": {{ ("https://arvlab.xyz/trials?domain=" + trial.domain)|tojson }}
            },
            {
                "@type": "ListItem",
                "position": 4,
                "name": {{ trial.title|tojson }},
                "item": {{ ("https://arvlab.xyz/trials/" + trial.id|string)|tojson }}
            }{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="/trials" class="text-decoration-none">
        <i data-lucide="list" style="width: 16px; height: 16px;" class="me-1"></i>
        Tasks
    </a>
</li>
<li class="breadcrumb-item">
    <a href="/trials?domain={{ trial.domain }}" class="text-decoration-none">{{ trial.domain.title() }}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    <i data-lucide="target" style="width: 16px; height: 16px;" class="me-1"></i>
    {{ trial.title }}
</li>
{% endblock %}

{% block description %}Join this {{ trial.domain.title() }} prediction task: {{ trial.title }}. {% if trial.status == 'open' %}Make predictions using remote viewing techniques.{% elif trial.status == 'live' %}Active live session.{% elif trial.status == 'settled' %}View results and analysis.{% endif %} Track accuracy, earn credits, develop ARV skills.{% endblock %}

{% block keywords %}{{ trial.title }}, {{ trial.domain }} prediction, remote viewing task, ARV, associative remote viewing, {{ trial.market_type }} market, consciousness research, precognition, prediction accuracy{% endblock %}

{% block og_title %}{{ trial.title }} | Remote Viewing Task - ARVLab{% endblock %}
{% block og_description %}{% if trial.status == 'open' %}Join this {{ trial.domain.title() }} prediction task and test your remote viewing abilities{% elif trial.status == 'live' %}Live prediction session active for {{ trial.title }}{% elif trial.status == 'settled' %}{{ trial.title }} results available - see prediction accuracy{% endif %}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_url %}{{ request.url.scheme }}://{{ request.url.netloc }}/trials/{{ trial.id }}{% endblock %}
{% block og_image %}{{ request.url.scheme }}://{{ request.url.netloc }}/static/images/arvlab-social-preview.png{% endblock %}

{% block twitter_title %}{{ trial.title }} | ARVLab{% endblock %}
{% block twitter_description %}{% if trial.status == 'open' %}Join this {{ trial.domain.title() }} remote viewing prediction task{% elif trial.status == 'live' %}LIVE: {{ trial.title }}{% elif trial.status == 'settled' %}Results: {{ trial.title }}{% endif %}{% endblock %}
{% block twitter_image %}{{ request.url.scheme }}://{{ request.url.netloc }}/static/images/arvlab-social-preview.png{% endblock %}

{% block canonical %}{{ request.url.scheme }}://{{ request.url.netloc }}/trials/{{ trial.id }}{% endblock %}

{% block additional_schema %}
    <!-- Trial-Specific Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "ResearchProject",
        "@id": {{ ("https://arvlab.xyz/trials/" + trial.id|string + "#research")|tojson }},
        "name": {{ trial.title|tojson }},
        "description": {% set event_spec = trial.event_spec_json | from_json %}{{ ("Remote viewing prediction experiment: " + trial.title + ". " + (event_spec.get('description') if event_spec and event_spec.get('description') else ("Associative Remote Viewing study for " + trial.domain + " market predictions.")))|tojson }},
        "url": {{ (request.url.scheme + "://" + request.url.netloc + "/trials/" + trial.id|string)|tojson }},
        "startDate": {{ trial.created_at.isoformat()|tojson }},
        {% if trial.result_time_utc %}"endDate": {{ trial.result_time_utc.isoformat()|tojson }},{% endif %}
        "measurementTechnique": "Associative Remote Viewing (ARV) methodology for prediction research",
        "about": {
            "@type": "Thing",
            "name": {{ (trial.domain.title() + " Market Prediction")|tojson }},
            "category": {{ trial.market_type.title()|tojson }}
        },
        "funder": {
            "@type": "Organization",
            "@id": "https://arvlab.xyz/#organization"
        },
        "keywords": ["remote viewing", "ARV", "prediction research", {{ trial.domain|tojson }}, "consciousness studies"]
    }
    </script>
    
    <!-- FAQ Structured Data for AI Discovery -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "How does remote viewing prediction work?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Remote viewing for predictions uses Associative Remote Viewing (ARV) methodology where viewers receive sensory impressions of target images that represent future outcomes. The technique bypasses analytical thinking to access unconscious information about future events."
                }
            },
            {
                "@type": "Question", 
                "name": {{ ("What is the accuracy rate for " + trial.domain + " predictions?")|tojson }},
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": {{ ("Historical ARV research shows accuracy rates significantly above chance levels. For " + trial.domain + " markets, experienced viewers achieve 60-80% accuracy rates, with some studies reaching 100% success in controlled conditions like the University of Colorado Boulder research.")|tojson }}
                }
            },
            {
                "@type": "Question",
                "name": "How do I participate in this prediction task?",
                "acceptedAnswer": {
                    "@type": "Answer", 
                    "text": "To participate: 1) Join the task while it's open, 2) Use the ARV wizard to record sensory impressions across 6 categories (colors, tactile, energy, smell, sound, visual), 3) Submit your descriptors before the deadline, 4) Wait for AI analysis and results after the event concludes."
                }
            },
            {
                "@type": "Question",
                "name": "What happens after I submit my predictions?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "After submission, you can request AI analysis of your impressions. Our AI uses CLIP embeddings and GPT-4o Vision to compare your descriptors against target images, providing detailed matching percentages across sensory categories and identifying the most likely outcome."
                }
            },
            {
                "@type": "Question",
                "name": "Is remote viewing scientifically validated?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, remote viewing has been studied in peer-reviewed research for decades. Recent studies include the University of Colorado Boulder research achieving 100% accuracy in stock market predictions (p < .01 statistical significance) and historical experiments generating over $250,000 in profits."
                }
            },
            {
                "@type": "Question",
                "name": "Can I earn money from accurate predictions?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "While ARVLab is primarily for research, successful practitioners have historically applied their enhanced prediction abilities to real-world scenarios including stock markets, sports betting, and lottery systems. Results vary by individual - practice and develop abilities responsibly."
                }
            }
        ]
    }
    </script>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">

    <!-- Trial Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="trial-header-card">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="trial-info flex-grow-1">
                        <div class="trial-status-badge mb-3">
                            <span class="status-indicator {{ trial.status.lower() }}">
                                <i data-lucide="{% if trial.status == 'draft' %}edit-3{% elif trial.status == 'open' %}play{% elif trial.status == 'live' %}zap{% else %}check-circle{% endif %}"></i>
                                {{ trial.status.title() }}
                            </span>
                            <span class="domain-badge">
                                <i data-lucide="target"></i>
                                {{ trial.domain.title() }}
                            </span>
                        </div>
                        
                        <h1 class="trial-title mb-3">{{ trial.title }}</h1>
                        
                        {% set event_spec = trial.event_spec_json | from_json %}
                        {% if event_spec and event_spec.get('description') %}
                        <p class="trial-description">{{ event_spec.get('description') }}</p>
                        {% endif %}
                        
                        <div class="trial-meta">
                            <div class="meta-item">
                                <i data-lucide="hash"></i>
                                <span>Target: <strong>{{ trial.target_number or 'TBD' }}</strong></span>
                            </div>
                            <div class="meta-item">
                                <i data-lucide="calendar"></i>
                                <span>Result: {{ trial.result_time_utc.strftime('%B %d, %Y at %H:%M UTC') }}</span>
                            </div>
                            <div class="meta-item">
                                <i data-lucide="layers"></i>
                                <span>{{ trial.market_type.title() }} Market</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Controls -->
                    {% if user and (user.is_admin or trial.created_by == user.id) %}
                    <div class="admin-actions">
                        {% if trial.status == 'draft' %}
                        <button class="btn btn-neutral btn-lg" onclick="startTrial({{ trial.id }})">
                            <i data-lucide="play"></i>
                            Start Task
                        </button>
                        {% endif %}
                        
                        {% if user.is_admin or (trial.created_by == user.id and trial.status == 'draft') %}
                        <a href="/trials/{{ trial.id }}/edit" class="btn btn-outline-neutral">
                            <i data-lucide="edit"></i>
                            {% if user.is_admin and trial.status != 'draft' %}Edit (Admin){% else %}Edit{% endif %}
                        </a>
                        {% endif %}
                        
                        {% if trial.is_group_tasking and trial.created_by == user.id %}
                        <a href="/trials/{{ trial.id }}/share" class="btn btn-success">
                            <i data-lucide="share-2"></i>
                            Share Task
                        </a>
                        {% endif %}
                        
                        {% if user.is_admin and trial.status != 'draft' %}
                        <button class="btn btn-outline-danger" onclick="confirmDeleteTrial()">
                            <i data-lucide="trash-2"></i>
                            Delete
                        </button>
                        {% endif %}
                        
                        {% if user.is_admin and trial.status in ['open', 'live'] %}
                        <button class="btn btn-warning" onclick="showForceSettleModal()">
                            <i data-lucide="flag"></i>
                            Force Settle
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Live Timer -->
                {% if trial.status == 'live' and trial.live_end_utc %}
                <div class="live-timer-card">
                    <div class="d-flex align-items-center">
                        <div class="live-indicator"></div>
                        <div>
                            <strong>Live Session Active</strong>
                            <div class="timer-text" id="liveTimer" data-end="{{ trial.live_end_utc.isoformat() }}">
                                Calculating...
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Direct Answer Section for AI Discovery -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="direct-answers-section">
                <div class="answer-grid">
                    <div class="answer-card">
                        <h4>How does this prediction work?</h4>
                        <p><strong>Direct Answer:</strong> This {{ trial.domain }} prediction uses Associative Remote Viewing (ARV) where participants receive sensory impressions of target images representing future outcomes. You record impressions across 6 categories (colors, textures, energy, smell, sound, visuals) before the event occurs.</p>
                    </div>
                    
                    <div class="answer-card">
                        <h4>What is the success rate?</h4>
                        <p><strong>Direct Answer:</strong> ARV research shows 60-80% accuracy rates for experienced viewers, significantly above random chance. The University of Colorado study achieved 100% success in stock predictions with statistical significance p < .01.</p>
                    </div>
                    
                    {% if trial.status == 'open' %}
                    <div class="answer-card">
                        <h4>How do I participate right now?</h4>
                        <p><strong>Direct Answer:</strong> Click "Start ARV Session" to record your sensory impressions. The system guides you through 6 categories of impressions. Submit before {{ trial.result_time_utc.strftime('%B %d at %H:%M UTC') }} to participate.</p>
                    </div>
                    {% elif trial.status == 'settled' %}
                    <div class="answer-card">
                        <h4>Can I see the results?</h4>
                        <p><strong>Direct Answer:</strong> Yes, this task is settled and results are visible below. {% if user %}If you participated, click "Analyze My Results" to see how your impressions matched the winning target.{% endif %}</p>
                    </div>
                    {% endif %}
                    
                    <div class="answer-card">
                        <h4>Is this scientifically validated?</h4>
                        <p><strong>Direct Answer:</strong> Yes, remote viewing has been studied for decades with peer-reviewed research. Studies show statistical odds against chance of 10²⁰ to 1, with documented profits exceeding $250,000 in financial applications.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Outcomes Section -->
        <div class="col-lg-8 mb-4">
            <div class="outcomes-section">
                <div class="section-header">
                    <h2>
                        <i data-lucide="target"></i>
                        Prediction Outcomes
                        {% if trial.status == 'settled' and result and winning_outcome_id %}
                        <span class="settled-badge">Settled</span>
                        {% endif %}
                    </h2>
                    {% if trial.domain == 'lottery' and trial.status in ['open', 'live'] %}
                    <a href="/trials/{{ trial.id }}/arv-wizard" class="btn btn-outline-neutral">
                        <i data-lucide="eye"></i>
                        ARV Session
                    </a>
                    {% endif %}
                </div>

                <div class="outcomes-grid">
                    {% for outcome in outcomes %}
                    {% if not (trial.status == 'settled' and result and winning_outcome_id and outcome.id != winning_outcome_id) %}
                    <div class="outcome-card {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}winner{% endif %}">
                        <div class="outcome-header">
                            <h3>{{ outcome.label }}</h3>
                            {% if trial.status == 'settled' and result and winning_outcome_id == outcome.id %}
                            <div class="winner-badge">
                                <i data-lucide="award"></i>
                                Winner
                            </div>
                            {% endif %}
                        </div>

                        {% if targets_by_outcome.get(outcome.id) %}
                        <div class="targets-container">
                            {% for target in targets_by_outcome[outcome.id] %}
                            <div class="target-item">
                                {% if user and (user.is_admin or (trial.created_by == user.id)) %}
                                    {% if trial.status in ['draft', 'open', 'live'] %}
                                    <!-- Protected View -->
                                    <div class="protected-target" onclick="revealTargetImageAdmin(this)">
                                        <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" 
                                             alt="{{ target.description }}" 
                                             class="hidden-target-image"
                                             style="opacity: 0; visibility: hidden;" />
                                        <div class="protection-overlay">
                                            <i data-lucide="eye-off"></i>
                                            <span>Click to Reveal</span>
                                            <small>Admin/Creator View</small>
                                        </div>
                                    </div>
                                    {% else %}
                                    <!-- Settled - Show Image -->
                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" 
                                         alt="{{ target.description }}" 
                                         class="target-image"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <div class="image-fallback" style="display: none;">
                                        <i data-lucide="image"></i>
                                        <span>Image not available</span>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    {% if trial.status == 'settled' %}
                                    <!-- Public settled view -->
                                    <img src="{% if target.uri.startswith('http') %}{{ target.uri }}{% elif target.uri.startswith('static/') %}/{{ target.uri }}{% elif target.uri.startswith('/') %}{{ target.uri }}{% else %}/static/{{ target.uri }}{% endif %}" 
                                         alt="{{ target.description }}" 
                                         class="target-image"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <div class="image-fallback" style="display: none;">
                                        <i data-lucide="image"></i>
                                        <span>Image not available</span>
                                    </div>
                                    {% else %}
                                    <!-- Protected placeholder -->
                                    <div class="target-placeholder">
                                        <i data-lucide="shield"></i>
                                        <span>Target Hidden</span>
                                        <small>ARV Protocol</small>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}


                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Conversion CTA for Visitors -->
            {% if not user %}
            <div class="sidebar-card mb-4 conversion-cta">
                <div class="conversion-header">
                    <h3><i data-lucide="compass" style="width: 20px; height: 20px;" class="me-2"></i>Join this Prediction Task</h3>
                    <p class="conversion-subtitle">Test your remote viewing abilities and track your accuracy</p>
                </div>
                
                <div class="conversion-benefits mb-4">
                    <div class="benefit-item">
                        <i data-lucide="target" style="width: 20px; height: 20px; color: #059669;"></i>
                        <span>Make predictions and earn credits</span>
                    </div>
                    <div class="benefit-item">
                        <i data-lucide="trending-up" style="width: 20px; height: 20px; color: #0891b2;"></i>
                        <span>Track accuracy across experiments</span>
                    </div>
                    <div class="benefit-item">
                        <i data-lucide="users" style="width: 20px; height: 20px; color: #7c3aed;"></i>
                        <span>Join the research community</span>
                    </div>
                    <div class="benefit-item">
                        <i data-lucide="brain" style="width: 20px; height: 20px; color: #dc2626;"></i>
                        <span>Develop consciousness skills</span>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <a href="/register?next=/trials/{{ trial.id }}" class="btn btn-success btn-lg">
                        <i data-lucide="user-plus"></i>
                        Start Free Account
                    </a>
                    <a href="/login?next=/trials/{{ trial.id }}" class="btn btn-outline-primary">
                        <i data-lucide="log-in"></i>
                        Already have an account?
                    </a>
                </div>
                
                <div class="conversion-stats mt-3">
                    <small class="text-muted">
                        <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                        Join {{ predictions|length if predictions else 0 }} participants {% if trial.status == 'settled' %}who completed{% else %}making predictions on{% endif %} this task
                    </small>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Actions -->
            {% if user %}
            <div class="sidebar-card mb-4">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    {% if trial.status in ['open', 'live'] %}
                    <a href="/trials/{{ trial.id }}/arv-wizard" class="btn btn-neutral btn-block">
                        <i data-lucide="eye"></i>
                        Start ARV Session
                    </a>
                    {% elif trial.status == 'settled' %}
                    <!-- AI Analysis Button for completed tasks -->
                    <button id="analyzeBtn" class="btn btn-neutral btn-block mb-2" onclick="runAIAnalysis()">
                        <i data-lucide="brain"></i>
                        Analyze My Results
                    </button>
                    <div id="analysisStatus" class="text-center mt-2" style="display: none;">
                        <small class="text-muted">Processing analysis...</small>
                    </div>
                    
                    <!-- Social Sharing for Successful Predictions -->
                    {% set user_prediction = None %}
                    {% for prediction in predictions %}
                        {% if prediction.user_id == user.id %}
                            {% set user_prediction = prediction %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if user_prediction and user_prediction.outcome_id == winning_outcome_id %}
                    <div class="social-sharing-section mt-3">
                        <div class="alert alert-success mb-3">
                            <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                            <strong>Correct Prediction!</strong> Share your success!
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-block" onclick="shareOnTwitter()">
                                <i data-lucide="twitter" style="width: 16px; height: 16px;"></i>
                                Share on Twitter
                            </button>
                            <button class="btn btn-success btn-block" onclick="shareOnWhatsApp()">
                                <i data-lucide="message-circle" style="width: 16px; height: 16px;"></i>
                                Share on WhatsApp
                            </button>
                            <button class="btn btn-outline-secondary btn-block" onclick="copyShareText()">
                                <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
                                Copy Achievement
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- General Task Sharing for All Users -->
                    <div class="general-sharing-section mt-3">
                        <h5 class="mb-3">
                            <i data-lucide="share-2" style="width: 16px; height: 16px;"></i>
                            Share this Task
                        </h5>
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="shareTaskOnTwitter()">
                                    <i data-lucide="twitter" style="width: 14px; height: 14px;"></i>
                                    Twitter
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success btn-sm w-100" onclick="shareTaskOnWhatsApp()">
                                    <i data-lucide="message-circle" style="width: 14px; height: 14px;"></i>
                                    WhatsApp
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info btn-sm w-100" onclick="shareTaskOnLinkedIn()">
                                    <i data-lucide="linkedin" style="width: 14px; height: 14px;"></i>
                                    LinkedIn
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="copyTaskLink()">
                                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                    Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Task Descriptors (Only show to task creator) -->
            {% if trial.status in ['open', 'live'] and descriptors and user and trial.created_by == user.id %}
            <div class="sidebar-card mb-4">
                <h3>Task Descriptors</h3>
                <div class="descriptors-container">
                    {% for descriptor in descriptors %}
                    <div class="descriptor-item border rounded mb-2 p-3" data-descriptor-id="{{ descriptor.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <span class="badge bg-secondary">
                                        <i data-lucide="{% if descriptor.category == 'colours' %}droplet{% elif descriptor.category == 'tactile' %}hand{% elif descriptor.category == 'energy' %}zap{% elif descriptor.category == 'smell' %}wind{% elif descriptor.category == 'sound' %}volume-2{% elif descriptor.category == 'visual' %}eye{% else %}circle{% endif %}"></i>
                                        {{ descriptor.category.title() if descriptor.category else 'General' }}
                                    </span>
                                </div>
                                <p class="mb-1">{{ descriptor.text }}</p>
                                <small class="text-muted">by {{ descriptor.author or 'Anonymous' }}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success btn-sm" onclick="voteDescriptor({{ descriptor.id }}, 'up')">
                                    <i data-lucide="thumbs-up"></i> {{ descriptor.upvotes or 0 }}
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="voteDescriptor({{ descriptor.id }}, 'down')">
                                    <i data-lucide="thumbs-down"></i> {{ descriptor.downvotes or 0 }}
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Task Statistics -->
            <div class="sidebar-card mb-4">
                <h3>Task Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">{{ predictions|length }}</div>
                        <div class="stat-label">Total Predictions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ participants|length }}</div>
                        <div class="stat-label">Participants</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ outcomes|length }}</div>
                        <div class="stat-label">Possible Outcomes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ descriptors|length if descriptors else 0 }}</div>
                        <div class="stat-label">Descriptors</div>
                    </div>
                </div>
            </div>

            <!-- Expert Research Citations -->
            <div class="sidebar-card mb-4">
                <h3>
                    <i data-lucide="book-open" style="width: 20px; height: 20px;"></i>
                    Scientific Validation
                </h3>
                <div class="expert-citations">
                    <div class="citation-item mb-3">
                        <blockquote class="citation-quote">
                            "We achieved a 100% success rate in predicting Dow Jones movements using ARV methodology, with statistical significance of p < .01"
                        </blockquote>
                        <cite class="citation-source">
                            <strong>Christopher Carson Smith et al.</strong><br>
                            <small class="text-muted">University of Colorado Boulder (2014)</small>
                        </cite>
                    </div>
                    
                    <div class="citation-item mb-3">
                        <blockquote class="citation-quote">
                            "Remote viewing applications to financial markets generated over $250,000 in documented profits"
                        </blockquote>
                        <cite class="citation-source">
                            <strong>Harold Puthoff, SRI International</strong><br>
                            <small class="text-muted">Silver Futures Experiment (1982)</small>
                        </cite>
                    </div>
                    
                    <div class="citation-item">
                        <blockquote class="citation-quote">
                            "Statistical meta-analysis of remote viewing experiments shows odds against chance of 10²⁰ to 1"
                        </blockquote>
                        <cite class="citation-source">
                            <strong>Dean Radin, Institute of Noetic Sciences</strong><br>
                            <small class="text-muted">Meta-Analysis of Psi Research (2018)</small>
                        </cite>
                    </div>
                </div>
                
                <div class="research-note mt-3">
                    <small class="text-muted">
                        <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                        Research published in peer-reviewed journals including Journal of Scientific Exploration and Frontiers in Psychology
                    </small>
                </div>
            </div>

            <!-- Recent Activity -->
            {% if recent_activity %}
            <div class="sidebar-card">
                <h3>Recent Activity</h3>
                <div class="activity-list">
                    {% for activity in recent_activity[:5] %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i data-lucide="{% if activity.type == 'prediction' %}trending-up{% elif activity.type == 'descriptor' %}edit{% else %}activity{% endif %}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">{{ activity.description }}</div>
                            <div class="activity-time">{{ activity.timestamp.strftime('%H:%M') }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>



<style>
/* AI Discovery & SEO Enhancement Styles */

/* Breadcrumb Styling */
.breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
}

.breadcrumb-item a {
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.breadcrumb-item.active {
    color: #111827;
    font-weight: 500;
}

/* Direct Answer Section */
.direct-answers-section {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 20px;
    padding: 2rem;
    border: 1px solid #e2e8f0;
    margin-bottom: 2rem;
}

.answer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.answer-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.answer-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.answer-card h4 {
    color: #111827;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    line-height: 1.3;
}

.answer-card p {
    margin: 0;
    line-height: 1.5;
    color: #374151;
    font-size: 0.95rem;
}

/* Expert Citations */
.expert-citations {
    space-y: 1rem;
}

.citation-item {
    border-left: 3px solid #667eea;
    padding-left: 1rem;
}

.citation-quote {
    font-style: italic;
    margin: 0 0 0.75rem 0;
    color: #374151;
    font-size: 0.9rem;
    line-height: 1.5;
    position: relative;
}

.citation-quote:before {
    content: '"';
    font-size: 1.2em;
    color: #667eea;
    position: absolute;
    left: -0.5rem;
    top: -0.2rem;
}

.citation-quote:after {
    content: '"';
    font-size: 1.2em;
    color: #667eea;
}

.citation-source {
    display: block;
    font-style: normal;
    font-size: 0.85rem;
}

.citation-source strong {
    color: #111827;
    font-weight: 600;
}

.research-note {
    background: #f8fafc;
    border-radius: 8px;
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .answer-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .direct-answers-section {
        padding: 1.5rem;
    }
    
    .answer-card {
        padding: 1rem;
    }
    
    .trial-meta {
        flex-direction: column;
        gap: 1rem;
    }
    
    .breadcrumb {
        font-size: 0.8rem;
    }
}

/* Trial Detail Page Styles */
.trial-header-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
}

.trial-status-badge {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.status-indicator, .domain-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
}

.status-indicator.open { background: #f0f9ff; color: #0c4a6e; border-color: #bae6fd; }
.status-indicator.live { background: #f0fdf4; color: #14532d; border-color: #bbf7d0; }
.status-indicator.settled { background: #fafaf9; color: #292524; border-color: #e7e5e4; }
.status-indicator.draft { background: #fef3c7; color: #92400e; border-color: #fde68a; }

.trial-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #111827;
    line-height: 1.2;
}

.trial-description {
    font-size: 1.125rem;
    color: #6b7280;
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.trial-meta {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6b7280;
    font-size: 0.95rem;
}

.admin-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.live-timer-card {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 1px solid #bbf7d0;
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1.5rem;
}

.live-indicator {
    width: 12px;
    height: 12px;
    background: #ef4444;
    border-radius: 50%;
    margin-right: 0.75rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.outcomes-section {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
}

.section-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.section-header h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #111827;
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
}

.settled-badge {
    background: #f3f4f6;
    color: #374151;
    padding: 0.25rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid #e5e7eb;
}

.outcomes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.outcome-card {
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
    background: #fafafa;
    transition: all 0.3s ease;
}

.outcome-card:hover {
    border-color: #d1d5db;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

.outcome-card.winner {
    border-color: #a3a3a3;
    background: linear-gradient(135deg, #f9f9f9 0%, #f3f4f6 100%);
}

.outcome-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.outcome-header h3 {
    color: #111827;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.winner-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #6b7280;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.targets-container {
    margin-bottom: 1rem;
}

.target-item img.target-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.protected-target {
    position: relative;
    cursor: pointer;
    border-radius: 12px;
    overflow: hidden;
    height: 200px;
    background: #f9fafb;
    border: 2px dashed #d1d5db;
}

.protection-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(243, 244, 246, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #6b7280;
}

.target-placeholder {
    height: 200px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
}

.image-fallback {
    height: 200px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
}



.sidebar-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
}

/* Conversion CTA Styles */
.conversion-cta {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0ea5e9;
    border-radius: 20px;
    padding: 2rem;
}

.conversion-header h3 {
    color: #1e40af;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.conversion-subtitle {
    color: #475569;
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
}

.conversion-benefits {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.benefit-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
    color: #374151;
    font-weight: 500;
}

.conversion-stats {
    text-align: center;
    padding-top: 1rem;
    border-top: 1px solid rgba(14, 165, 233, 0.2);
}

.sidebar-card h3 {
    color: #111827;
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.activity-icon {
    width: 32px;
    height: 32px;
    background: #f3f4f6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
}

.activity-content {
    flex: 1;
}

.activity-text {
    font-size: 0.875rem;
    color: #374151;
}

.activity-time {
    font-size: 0.75rem;
    color: #9ca3af;
}

.btn-neutral {
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-neutral:hover {
    background: #4b5563;
    color: white;
    transform: translateY(-1px);
}

.btn-outline-neutral {
    background: transparent;
    color: #6b7280;
    border: 2px solid #d1d5db;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-outline-neutral:hover {
    background: #6b7280;
    color: white;
    border-color: #6b7280;
    transform: translateY(-1px);
}

.btn-block {
    width: 100%;
}

.selected-outcome {
    background: #f3f4f6;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    font-weight: 600;
    color: #374151;
}

/* Success Modal Styles */
.success-animation {
    animation: successPulse 0.6s ease-in-out;
}

.success-circle {
    width: 80px;
    height: 80px;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    animation: successGlow 2s ease-in-out infinite;
}

.stat-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    color: #64748b;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
}

.submission-details .stat-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.submission-details .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.categories-submitted .badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
}

.next-steps .btn {
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.next-steps .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.progress-section .alert {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
}

@keyframes successPulse {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes successGlow {
    0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .trial-title {
        font-size: 2rem;
    }
    
    .trial-meta {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .outcomes-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .submission-details .row {
        flex-direction: column;
    }
    
    .next-steps .row {
        flex-direction: column;
    }
}
</style>

<script>
// Live timer functionality
function updateLiveTimer() {
    const timerElement = document.getElementById('liveTimer');
    if (!timerElement) return;
    
    const endTime = new Date(timerElement.dataset.end);
    const now = new Date();
    const timeLeft = endTime - now;
    
    if (timeLeft <= 0) {
        timerElement.innerHTML = 'Session Ended';
        return;
    }
    
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    
    timerElement.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} remaining`;
}

// Update timer every second
setInterval(updateLiveTimer, 1000);
updateLiveTimer();



// Descriptor voting function
function voteDescriptor(descriptorId, voteType) {
    // This would typically make an API call to vote on the descriptor
    console.log(`Voting ${voteType} for descriptor ${descriptorId}`);
    showToast('Voting functionality coming soon!', 'info');
}

// Social sharing functions
function shareOnTwitter() {
    const trialTitle = "{{ trial.title }}";
    const domain = "{{ trial.domain.title() }}";
    const accuracy = calculateUserAccuracy();
    
    const shareText = `Just made a successful prediction on ARVLab! 
    
Task: "${trialTitle}" (${domain})
Accuracy Rate: ${accuracy}%

Join me in exploring the fascinating world of remote viewing and prediction research!

#RemoteViewing #PredictionResearch #ARVLab`;
    
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(window.location.href)}`;
    window.open(url, '_blank');
}

function shareOnWhatsApp() {
    const trialTitle = "{{ trial.title }}";
    const domain = "{{ trial.domain.title() }}";
    const accuracy = calculateUserAccuracy();
    
    const shareText = `Just nailed another prediction on ARVLab!

Task: "${trialTitle}" (${domain})
My Accuracy: ${accuracy}%

I'm exploring remote viewing and prediction research - it's fascinating! Want to try? Check this out: ${window.location.href}`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
    window.open(url, '_blank');
}

function copyShareText() {
    const trialTitle = "{{ trial.title }}";
    const domain = "{{ trial.domain.title() }}";
    const accuracy = calculateUserAccuracy();
    
    const shareText = `Successful Prediction Achievement!

Task: "${trialTitle}" (${domain})
Accuracy Rate: ${accuracy}%
Platform: ARVLab - Remote Viewing Research

${window.location.href}`;
    
    navigator.clipboard.writeText(shareText).then(() => {
        showToast('Achievement text copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy text', 'error');
    });
}

function calculateUserAccuracy() {
    // Get user's overall accuracy from the user object
    {% if user and user.total_predictions > 0 %}
    return Math.round(({{ user.correct_predictions }} / {{ user.total_predictions }}) * 100);
    {% else %}
    return 100; // First prediction
    {% endif %}
}

// General task sharing functions (for all users)
function shareTaskOnTwitter() {
    const trialTitle = "{{ trial.title }}";
    const domain = "{{ trial.domain.title() }}";
    const status = "{{ trial.status }}";
    
    let shareText = `🔮 Check out this ${domain} prediction task on ARVLab:\n\n"${trialTitle}"\n\n`;
    
    if (status === 'open') {
        shareText += 'Join the experiment and test your remote viewing abilities!';
    } else if (status === 'live') {
        shareText += '🔴 LIVE session active!';
    } else if (status === 'settled') {
        shareText += 'Results are in!';
    }
    
    shareText += '\n\n#RemoteViewing #ARV #PredictionResearch';
    
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(window.location.href)}`;
    window.open(url, '_blank');
}

function shareTaskOnWhatsApp() {
    const trialTitle = "{{ trial.title }}";
    const domain = "{{ trial.domain.title() }}";
    const status = "{{ trial.status }}";
    
    let shareText = `🔮 *${trialTitle}*\n\nInteresting ${domain} prediction experiment on ARVLab!\n\n`;
    
    if (status === 'open') {
        shareText += 'Join and test your remote viewing abilities.';
    } else if (status === 'live') {
        shareText += '🔴 LIVE session happening now!';
    } else if (status === 'settled') {
        shareText += 'Check out the results.';
    }
    
    shareText += `\n\n${window.location.href}`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
    window.open(url, '_blank');
}

function shareTaskOnLinkedIn() {
    const trialTitle = "{{ trial.title }}";
    const domain = "{{ trial.domain.title() }}";
    const status = "{{ trial.status }}";
    
    let shareText = `Fascinating ${domain} prediction research on ARVLab: "${trialTitle}". `;
    
    if (status === 'open') {
        shareText += 'Join the experiment to explore consciousness-based prediction methods.';
    } else if (status === 'settled') {
        shareText += 'Interesting results from this remote viewing study.';
    }
    
    shareText += ' #ConsciousnessResearch #RemoteViewing #PredictionScience';
    
    const url = `https://linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}&title=${encodeURIComponent(trialTitle)}&summary=${encodeURIComponent(shareText)}`;
    window.open(url, '_blank');
}

function copyTaskLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        showToast('Task link copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Task link copied to clipboard!', 'success');
    });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1000; min-width: 250px;';
    toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'x-circle'}" style="width: 16px; height: 16px;"></i> ${message}`;
    document.body.appendChild(toast);
    // Safe Lucide initialization
    if (typeof window.initializeLucideIcons === 'function') {
        window.initializeLucideIcons();
    }
    setTimeout(() => toast.remove(), 3000);
}

// Admin functions
function revealTargetImageAdmin(element) {
    const overlay = element.querySelector('.protection-overlay');
    const image = element.querySelector('.hidden-target-image');
    
    if (overlay && image) {
        overlay.style.display = 'none';
        image.style.display = 'block';
        image.style.opacity = '1';
        image.style.visibility = 'visible';
        image.classList.remove('hidden-target-image');
        image.classList.add('target-image');
    }
}

function startTrial(trialId) {
    if (confirm('Are you sure you want to start this trial? This action cannot be undone.')) {
        fetch(`/trials/${trialId}/start`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                showToast('Trial started successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error starting trial', 'error');
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
        });
    }
}

function confirmDeleteTrial() {
    if (confirm('Are you sure you want to delete this trial? This action cannot be undone.')) {
        fetch(`/api/trials/{{ trial.id }}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Trial deleted successfully!', 'success');
                setTimeout(() => window.location.href = '/trials', 1500);
            } else {
                showToast(data.message || 'Error deleting trial', 'error');
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
        });
    }
}

// Utility functions
function showToast(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'secondary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize Lucide icons
    if (typeof window.initializeLucideIcons === "function") {
        // Safe Lucide initialization
    if (typeof window.initializeLucideIcons === 'function') {
        window.initializeLucideIcons();
    }
    }
});

async function runAIAnalysis() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisStatus = document.getElementById('analysisStatus');
    
    // Show loading state
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
    analysisStatus.style.display = 'block';
    
    try {
        const formData = new FormData();
        formData.append('trial_id', {{ trial.id }});
        formData.append('user_id', {{ user.id }});
        
        const response = await fetch('/api/analyze_viewing', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Redirect to analysis results page
            window.location.href = `/trials/{{ trial.id }}/analysis/{{ user.id }}`;
        } else {
            alert('Analysis failed: ' + result.error);
            // Reset button state
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i data-lucide="brain"></i> Analyze My Results';
            analysisStatus.style.display = 'none';
            if (typeof window.initializeLucideIcons === "function") {
                // Safe Lucide initialization
    if (typeof window.initializeLucideIcons === 'function') {
        window.initializeLucideIcons();
    }
            }
        }
    } catch (error) {
        alert('Error running analysis: ' + error.message);
        // Reset button state
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i data-lucide="brain"></i> Analyze My Results';
        analysisStatus.style.display = 'none';
        if (typeof window.initializeLucideIcons === "function") {
            // Safe Lucide initialization
    if (typeof window.initializeLucideIcons === 'function') {
        window.initializeLucideIcons();
    }
        }
    }
}

// Admin trial management functions
function confirmDeleteTrial() {
    if (confirm('Are you sure you want to delete this trial? This action cannot be undone and will remove all associated data including predictions, judgments, and descriptors.')) {
        deleteTrial();
    }
}

async function deleteTrial() {
    try {
        const response = await fetch(`/admin/trials/{{ trial.id }}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Trial deleted successfully');
            window.location.href = '/trials';
        } else {
            alert('Failed to delete trial: ' + result.message);
        }
    } catch (error) {
        alert('Error deleting trial: ' + error.message);
    }
}

function showForceSettleModal() {
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="forceSettleModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Force Settle Trial</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Warning:</strong> This will manually settle the trial with the outcome you select. All participant predictions will be scored based on this choice.</p>
                        <div class="mb-3">
                            <label for="winningOutcome" class="form-label">Select Winning Outcome:</label>
                            <select class="form-select" id="winningOutcome">
                                {% for outcome in outcomes %}
                                <option value="{{ outcome.id }}">{{ outcome.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="forceSettleTrial()">Force Settle</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('forceSettleModal'));
    modal.show();
    
    // Clean up modal when closed
    document.getElementById('forceSettleModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

async function forceSettleTrial() {
    const winningOutcomeId = document.getElementById('winningOutcome').value;
    
    if (!winningOutcomeId) {
        alert('Please select a winning outcome');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('winning_outcome_id', winningOutcomeId);
        
        const response = await fetch(`/admin/trials/{{ trial.id }}/force-settle`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Trial settled successfully: ' + result.message);
            location.reload(); // Refresh to show updated status
        } else {
            alert('Failed to settle trial: ' + result.message);
        }
    } catch (error) {
        alert('Error settling trial: ' + error.message);
    } finally {
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('forceSettleModal')).hide();
    }
}
</script>

<!-- Descriptor Submission Success Modal -->
<div class="modal fade" id="descriptorSuccessModal" tabindex="-1" role="dialog" aria-labelledby="descriptorSuccessModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <!-- Success Animation and Icon -->
                <div class="success-animation mb-4">
                    <div class="success-circle">
                        <div class="success-checkmark">
                            <i data-lucide="check-circle" style="width: 48px; height: 48px; color: #10b981;"></i>
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <h3 class="modal-title mb-3" id="descriptorSuccessModalTitle">
                    <i data-lucide="check-circle" style="width: 20px; height: 20px;" class="me-2"></i>Impressions Successfully Recorded!
                </h3>
                <p class="lead mb-4" id="successSummary">
                    Your remote viewing impressions have been submitted and saved.
                </p>

                <!-- Submission Details -->
                <div class="submission-details mb-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number" id="categoriesSubmitted">0</div>
                                <div class="stat-label">Categories</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number" id="totalImpressions">0</div>
                                <div class="stat-label">Total Impressions</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number">+5</div>
                                <div class="stat-label">Experience Points</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Submitted -->
                <div class="categories-submitted mb-4">
                    <h5 class="mb-3">Categories Recorded:</h5>
                    <div id="submittedCategories" class="d-flex flex-wrap gap-2 justify-content-center">
                        <!-- Dynamic category badges will be inserted here -->
                    </div>
                </div>

                <!-- Next Steps -->
                <div class="next-steps">
                    <h5 class="mb-3">What's Next?</h5>
                    <div class="row g-2">
                        <div class="col-12">
                            <button class="btn btn-primary btn-lg mb-2" onclick="triggerAIAnalysis()">
                                <i data-lucide="brain" style="width: 20px; height: 20px;"></i>
                                Get AI Analysis of Your Results
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-primary" onclick="shareSubmissionSuccess()">
                                <i data-lucide="share-2" style="width: 16px; height: 16px;"></i>
                                Share Progress
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-secondary" onclick="viewMyDashboard()">
                                <i data-lucide="bar-chart-2" style="width: 16px; height: 16px;"></i>
                                View Dashboard
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progress Tracking -->
                <div class="progress-section mt-4">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <i data-lucide="clock" style="width: 20px; height: 20px;" class="me-2"></i>
                            <div>
                                <strong>Task Status:</strong> Your predictions are recorded. 
                                {% if trial.status == 'open' %}
                                Wait for task to go live for results.
                                {% elif trial.status == 'live' %}
                                Results available when task completes.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="continueBrowsing()">
                    <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                    Explore More Tasks
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}